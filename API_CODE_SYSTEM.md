# API Code System Documentation

## Overview

The API code system is designed to securely connect external sites (like faddedsmm.com) to your Xtrabusiness system for transaction notifications.

## How It Works

### 1. **API Code Generation**
- **Generated by**: Xtrabusiness (receiving system)
- **When**: When you add a new site
- **Format**: 8-character lowercase alphanumeric code (e.g., `abc123xy`)
- **Purpose**: Unique identifier for the site

### 2. **API Key Generation**
- **Generated by**: Xtrabusiness (receiving system)
- **When**: When you add a new site
- **Format**: 64-character random string
- **Purpose**: Authentication key for webhook requests

### 3. **Webhook URL**
- **Provided by**: You (the Xtrabusiness owner)
- **Format**: `https://yourdomain.com/webhook`
- **Purpose**: Where external sites send transaction notifications

## Site Integration Process

### Step 1: Add Site in Xtrabusiness
1. Go to Dashboard → Sites → Add New Site
2. Fill in:
   - **Site Name**: e.g., "faddedsmm.com"
   - **Site URL**: e.g., "https://faddedsmm.com"
   - **Webhook URL**: Your webhook endpoint (e.g., "https://xtrabusiness.com/webhook")
   - **Allowed IPs**: (Optional) IP addresses that can send webhooks

3. **System Auto-Generates**:
   - **API Code**: e.g., `faddedsmm`
   - **API Key**: e.g., `abc123def456...` (64 characters)

### Step 2: Configure External Site
The external site (like faddedsmm.com) needs to configure:

```env
XTRABUSINESS_WEBHOOK_URL="https://xtrabusiness.com/webhook"
XTRABUSINESS_API_KEY="your_generated_api_key_here"
XTRABUSINESS_API_CODE="faddedsmm"
```

### Step 3: Send Transaction Notifications
When a transaction occurs on the external site, it sends:

```json
{
    "reference": "TXN_123456",
    "amount": 1000.00,
    "status": "successful",
    "payment_method": "xtrapay",
    "customer_email": "user@example.com",
    "customer_name": "John Doe",
    "site_name": "faddedsmm.com",
    "site_url": "https://faddedsmm.com",
    "transaction_date": "2024-01-01T12:00:00Z",
    "metadata": {
        "deposit_id": 123,
        "user_id": 456,
        "final_amount": 1100.00,
        "charge": 100.00
    }
}
```

**Headers**:
```
Content-Type: application/json
X-API-Key: your_generated_api_key_here
X-API-Code: faddedsmm
```

## Security Features

### 1. **API Key Authentication**
- 64-character random key
- Required in all webhook requests
- Validated on every request

### 2. **IP Whitelisting** (Optional)
- Restrict webhook sources to specific IP addresses
- Format: `192.168.1.1,10.0.0.1`

### 3. **API Code Validation**
- Ensures requests come from authorized sites
- Prevents cross-site request forgery

## Example Integration

### For faddedsmm.com:

1. **Get credentials from Xtrabusiness**:
   - API Code: `faddedsmm`
   - API Key: `abc123def456ghi789jkl012mno345pqr678stu901vwx234yz`
   - Webhook URL: `https://xtrabusiness.com/webhook`

2. **Configure faddedsmm.com**:
   ```env
   XTRABUSINESS_WEBHOOK_URL="https://xtrabusiness.com/webhook"
   XTRABUSINESS_API_KEY="abc123def456ghi789jkl012mno345pqr678stu901vwx234yz"
   XTRABUSINESS_API_CODE="faddedsmm"
   ```

3. **Test the integration**:
   ```bash
   cd faddedsmm.com
   php artisan test:xtrabusiness-webhook
   ```

## Important Notes

### ✅ **Do's**
- Keep API keys secure and private
- Use HTTPS for webhook URLs
- Test integrations before going live
- Monitor webhook logs for errors

### ❌ **Don'ts**
- Share API keys publicly
- Use HTTP (non-secure) webhook URLs
- Change API codes after site creation
- Delete sites with transaction history (use archive instead)

## Troubleshooting

### Common Issues

1. **"Invalid API Key" Error**
   - Check that the API key is correct
   - Ensure no extra spaces or characters

2. **"Invalid API Code" Error**
   - Verify the API code matches exactly
   - Check for case sensitivity

3. **"Webhook URL Not Accessible" Error**
   - Ensure Xtrabusiness is running
   - Check firewall/network settings
   - Verify HTTPS certificate is valid

### Debugging

1. **Check Xtrabusiness logs**:
   ```bash
   tail -f storage/logs/laravel.log | grep webhook
   ```

2. **Test webhook manually**:
   ```bash
   curl -X POST https://xtrabusiness.com/webhook \
     -H "Content-Type: application/json" \
     -H "X-API-Key: your_api_key" \
     -H "X-API-Code: your_api_code" \
     -d '{"test": "data"}'
   ```

## Support

If you encounter issues:
1. Check the logs for detailed error messages
2. Verify all configuration is correct
3. Test the webhook manually
4. Contact support with specific error details 